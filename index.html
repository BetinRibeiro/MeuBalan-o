<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-bar {
            transition: height 0.5s ease-in-out;
        }
        
        .progress-ring {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Cabe√ßalho -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">
                <i class="fas fa-wallet mr-2"></i>Controle Financeiro Pessoal
            </h1>
            <p class="text-gray-600">Acompanhe suas receitas e despesas de forma simples e eficiente</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Painel de Resumo -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Resumo Mensal</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-green-600 mb-1">Receitas</p>
                            <p class="text-2xl font-bold text-green-700" id="total-receitas">R$ 0,00</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-red-600 mb-1">Despesas</p>
                            <p class="text-2xl font-bold text-red-700" id="total-despesas">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg text-center mb-6">
                        <p class="text-sm text-blue-600 mb-1">Saldo do M√™s</p>
                        <p class="text-3xl font-bold text-blue-700" id="saldo-mes">R$ 0,00</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">Progresso do or√ßamento</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-500 mb-6">
                        <span>R$ 0,00</span>
                        <span id="meta-orcamento">R$ 0,00</span>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="exportToCSV()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm transition">
                            <i class="fas fa-download mr-1"></i> Exportar CSV
                        </button>
                        <button onclick="importFromCSV()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg text-sm transition">
                            <i class="fas fa-upload mr-1"></i> Importar CSV
                        </button>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Distribui√ß√£o por Categoria</h2>
                    <div id="category-chart" class="h-64">
                        <!-- Gr√°fico ser√° inserido via JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Formul√°rio e Lista de Transa√ß√µes -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Nova Transa√ß√£o</h2>
                    
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <div class="flex rounded-md shadow-sm">
                                <button type="button" id="btn-receita" class="flex-1 py-2 px-4 rounded-l-md bg-green-500 text-white font-medium">Receita</button>
                                <button type="button" id="btn-despesa" class="flex-1 py-2 px-4 rounded-r-md bg-gray-200 text-gray-700 font-medium">Despesa</button>
                            </div>
                            <input type="hidden" id="transaction-type" value="receita">
                        </div>
                        
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                            <input type="number" id="amount" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <select id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias ser√£o preenchidas via JavaScript -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                            <input type="text" id="description" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition">
                                <i class="fas fa-plus-circle mr-1"></i> Adicionar Transa√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico de Transa√ß√µes</h2>
                        <div class="flex space-x-2">
                            <select id="filter-month" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                <!-- Meses ser√£o preenchidos via JavaScript -->
                            </select>
                            <select id="filter-year" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                <!-- Anos ser√£o preenchidos via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-500 border-b">
                                    <th class="pb-2">Data</th>
                                    <th class="pb-2">Descri√ß√£o</th>
                                    <th class="pb-2">Categoria</th>
                                    <th class="pb-2 text-right">Valor</th>
                                    <th class="pb-2 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list">
                                <!-- Transa√ß√µes ser√£o preenchidas via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="empty-state" class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-4xl mb-2"></i>
                        <p>Nenhuma transa√ß√£o encontrada</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializa√ß√£o do banco de dados
        let db;
        const DB_NAME = "FinanceDB";
        const DB_VERSION = 1;
        const STORE_NAME = "transactions";
        
        // Flag para verificar se o banco est√° pronto
        let dbReady = false;
        
        // Categorias pr√©-definidas
        const categories = {
            receita: ["Sal√°rio", "Freelance", "Investimentos", "Presente", "Outros"],
            despesa: ["Alimenta√ß√£o", "Transporte", "Moradia", "Sa√∫de", "Educa√ß√£o", "Lazer", "Compras", "Outros"]
        };
        
        // Elementos DOM
        const transactionForm = document.getElementById('transaction-form');
        const transactionsList = document.getElementById('transactions-list');
        const emptyState = document.getElementById('empty-state');
        const totalReceitas = document.getElementById('total-receitas');
        const totalDespesas = document.getElementById('total-despesas');
        const saldoMes = document.getElementById('saldo-mes');
        const progressBar = document.getElementById('progress-bar');
        const btnReceita = document.getElementById('btn-receita');
        const btnDespesa = document.getElementById('btn-despesa');
        const transactionType = document.getElementById('transaction-type');
        const categorySelect = document.getElementById('category');
        const filterMonth = document.getElementById('filter-month');
        const filterYear = document.getElementById('filter-year');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual no campo de data
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
            
            // Preencher selects de m√™s e ano
            populateMonthYearFilters();
            
            // Configurar categorias
            updateCategoryOptions();
            
            // Inicializar banco de dados
            initDB().then(() => {
                dbReady = true;
                loadTransactions();
            }).catch(error => {
                console.error('Erro ao inicializar banco de dados:', error);
                alert('Erro ao inicializar o banco de dados. Recarregue a p√°gina.');
            });
            
            // Configurar eventos
            setupEventListeners();
        });
        
        // Configurar listeners de evento
        function setupEventListeners() {
            // Alternar entre receita e despesa
            btnReceita.addEventListener('click', () => setTransactionType('receita'));
            btnDespesa.addEventListener('click', () => setTransactionType('despesa'));
            
            // Submiss√£o do formul√°rio
            transactionForm.addEventListener('submit', addTransaction);
            
            // Filtros
            filterMonth.addEventListener('change', loadTransactions);
            filterYear.addEventListener('change', loadTransactions);
            
            // Formata√ß√£o autom√°tica do valor
            amountInput.addEventListener('blur', formatCurrency);
        }
        
        // Formatar valor como moeda
        function formatCurrency(e) {
            let value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                e.target.value = value.toFixed(2);
            }
        }
        
        // Popular filtros de m√™s e ano
        function populateMonthYearFilters() {
            // Meses
            const months = [
                "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                // Selecionar m√™s atual
                if (index === new Date().getMonth()) {
                    option.selected = true;
                }
                filterMonth.appendChild(option);
            });
            
            // Anos (5 anos para tr√°s e 1 para frente)
            const currentYear = new Date().getFullYear();
            for (let i = currentYear - 5; i <= currentYear + 1; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                // Selecionar ano atual
                if (i === currentYear) {
                    option.selected = true;
                }
                filterYear.appendChild(option);
            }
        }
        
        // Definir tipo de transa√ß√£o (receita/despesa)
        function setTransactionType(type) {
            transactionType.value = type;
            
            if (type === 'receita') {
                btnReceita.classList.remove('bg-gray-200', 'text-gray-700');
                btnReceita.classList.add('bg-green-500', 'text-white');
                btnDespesa.classList.remove('bg-red-500', 'text-white');
                btnDespesa.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                btnDespesa.classList.remove('bg-gray-200', 'text-gray-700');
                btnDespesa.classList.add('bg-red-500', 'text-white');
                btnReceita.classList.remove('bg-green-500', 'text-white');
                btnReceita.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            updateCategoryOptions();
        }
        
        // Atualizar op√ß√µes de categoria baseado no tipo selecionado
        function updateCategoryOptions() {
            // Limpar select
            categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            // Adicionar categorias baseadas no tipo
            const typeCategories = categories[transactionType.value];
            typeCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        // Inicializar o IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Criar object store se n√£o existir
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        
                        // Criar √≠ndices para busca
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('type', 'type', { unique: false });
                        store.createIndex('category', 'category', { unique: false });
                        
                        // Adicionar dados de demonstra√ß√£o quando o banco for criado pela primeira vez
                        addDemoData(store);
                    }
                };
            });
        }
        
        // Adicionar dados de demonstra√ß√£o
        function addDemoData(store) {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            // Dados de demonstra√ß√£o
            const demoTransactions = [
                {
                    type: 'receita',
                    amount: 3500.00,
                    category: 'Sal√°rio',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-05`,
                    description: 'Sal√°rio mensal',
                    createdAt: new Date()
                },
                {
                    type: 'receita',
                    amount: 1200.00,
                    category: 'Freelance',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-15`,
                    description: 'Projeto cliente X',
                    createdAt: new Date()
                },
                {
                    type: 'despesa',
                    amount: -850.00,
                    category: 'Moradia',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-10`,
                    description: 'Aluguel',
                    createdAt: new Date()
                },
                {
                    type: 'despesa',
                    amount: -320.00,
                    category: 'Alimenta√ß√£o',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-12`,
                    description: 'Supermercado',
                    createdAt: new Date()
                },
                {
                    type: 'despesa',
                    amount: -150.00,
                    category: 'Transporte',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-18`,
                    description: 'Combust√≠vel',
                    createdAt: new Date()
                },
                {
                    type: 'despesa',
                    amount: -89.90,
                    category: 'Lazer',
                    date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-20`,
                    description: 'Cinema e jantar',
                    createdAt: new Date()
                }
            ];
            
            // Adicionar transa√ß√µes de demonstra√ß√£o
            demoTransactions.forEach(transaction => {
                store.add(transaction);
            });
        }
        
        // Adicionar transa√ß√£o
        function addTransaction(e) {
            e.preventDefault();
            
            if (!dbReady) {
                alert('Banco de dados n√£o est√° pronto. Aguarde um momento e tente novamente.');
                return;
            }
            
            const type = transactionType.value;
            const amount = parseFloat(amountInput.value);
            const category = categorySelect.value;
            const date = dateInput.value;
            const description = document.getElementById('description').value;
            
            if (!amount || !category || !date || !description) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            const transaction = {
                type,
                amount: type === 'despesa' ? -amount : amount,
                category,
                date,
                description,
                createdAt: new Date()
            };
            
            try {
                const transactionDB = db.transaction([STORE_NAME], 'readwrite');
                const store = transactionDB.objectStore(STORE_NAME);
                const request = store.add(transaction);
                
                request.onsuccess = () => {
                    // Limpar formul√°rio
                    amountInput.value = '';
                    document.getElementById('description').value = '';
                    dateInput.value = new Date().toISOString().split('T')[0];
                    setTransactionType('receita');
                    
                    // Recarregar transa√ß√µes
                    loadTransactions();
                };
                
                request.onerror = (event) => {
                    console.error('Erro ao adicionar:', event.target.error);
                    alert('Erro ao adicionar transa√ß√£o. Tente novamente.');
                };
            } catch (error) {
                console.error('Erro na transa√ß√£o:', error);
                alert('Erro ao processar transa√ß√£o. Tente novamente.');
            }
        }
        
        // Carregar transa√ß√µes com base nos filtros
        function loadTransactions() {
            if (!dbReady) {
                console.log('Banco de dados n√£o est√° pronto para carregar transa√ß√µes');
                return;
            }
            
            const month = parseInt(filterMonth.value);
            const year = parseInt(filterYear.value);
            
            try {
                const transactionDB = db.transaction([STORE_NAME], 'readonly');
                const store = transactionDB.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const allTransactions = request.result;
                    
                    // Filtrar por m√™s/ano selecionados
                    const filteredTransactions = allTransactions.filter(transaction => {
                        const transactionDate = new Date(transaction.date);
                        return transactionDate.getMonth() + 1 === month && 
                               transactionDate.getFullYear() === year;
                    });
                    
                    // Ordenar por data (mais recente primeiro)
                    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Exibir transa√ß√µes
                    displayTransactions(filteredTransactions);
                    
                    // Atualizar resumo
                    updateSummary(filteredTransactions);
                    
                    // Atualizar gr√°fico
                    updateChart(filteredTransactions);
                };
                
                request.onerror = (event) => {
                    console.error('Erro ao carregar transa√ß√µes:', event.target.error);
                };
            } catch (error) {
                console.error('Erro ao acessar banco de dados:', error);
            }
        }
        
        // Exibir transa√ß√µes na tabela
        function displayTransactions(transactions) {
            transactionsList.innerHTML = '';
            
            if (transactions.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 fade-in';
                
                // Formatar data
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('pt-BR');
                
                // Classe e √≠cone baseado no tipo
                const amountClass = transaction.amount >= 0 ? 'text-green-600' : 'text-red-600';
                const icon = transaction.amount >= 0 ? 'fa-arrow-up-right' : 'fa-arrow-down-left';
                
                row.innerHTML = `
                    <td class="py-3">${formattedDate}</td>
                    <td class="py-3">${transaction.description}</td>
                    <td class="py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${transaction.amount >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${transaction.category}
                        </span>
                    </td>
                    <td class="py-3 text-right font-medium ${amountClass}">
                        <i class="fas ${icon} mr-1"></i> R$ ${Math.abs(transaction.amount).toFixed(2)}
                    </td>
                    <td class="py-3 text-center">
                        <button onclick="deleteTransaction(${transaction.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                transactionsList.appendChild(row);
            });
        }
        
        // Atualizar resumo financeiro
        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(transaction => {
                if (transaction.amount >= 0) {
                    totalIncome += transaction.amount;
                } else {
                    totalExpense += Math.abs(transaction.amount);
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            totalReceitas.textContent = `R$ ${totalIncome.toFixed(2)}`;
            totalDespesas.textContent = `R$ ${totalExpense.toFixed(2)}`;
            saldoMes.textContent = `R$ ${balance.toFixed(2)}`;
            
            // Atualizar barra de progresso (baseado na meta de despesas)
            const expenseGoal = 0.7 * totalIncome; // Meta de 70% da receita para despesas
            document.getElementById('meta-orcamento').textContent = `R$ ${expenseGoal.toFixed(2)}`;
            
            if (expenseGoal > 0) {
                const progressPercent = Math.min(100, (totalExpense / expenseGoal) * 100);
                progressBar.style.width = `${progressPercent}%`;
                
                // Mudar cor baseado no percentual
                if (progressPercent > 90) {
                    progressBar.className = 'bg-red-600 h-2.5 rounded-full';
                } else if (progressPercent > 70) {
                    progressBar.className = 'bg-yellow-500 h-2.5 rounded-full';
                } else {
                    progressBar.className = 'bg-green-600 h-2.5 rounded-full';
                }
            } else {
                progressBar.style.width = '0%';
            }
        }
        
        // Atualizar gr√°fico de categorias
        function updateChart(transactions) {
            const chartContainer = document.getElementById('category-chart');
            chartContainer.innerHTML = '';
            
            // Agrupar despesas por categoria
            const expensesByCategory = {};
            
            transactions.forEach(transaction => {
                if (transaction.amount < 0) {
                    const category = transaction.category;
                    const amount = Math.abs(transaction.amount);
                    
                    if (expensesByCategory[category]) {
                        expensesByCategory[category] += amount;
                    } else {
                        expensesByCategory[category] = amount;
                    }
                }
            });
            
            // Ordenar categorias por valor (maior primeiro)
            const sortedCategories = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1]);
            
            // Calcular valor total de despesas
            const totalExpenses = sortedCategories.reduce((sum, [, value]) => sum + value, 0);
            
            // Criar gr√°fico de barras
            if (sortedCategories.length > 0) {
                const maxValue = Math.max(...sortedCategories.map(([, value]) => value));
                
                sortedCategories.forEach(([category, value]) => {
                    const percent = (value / totalExpenses) * 100;
                    const barHeight = (value / maxValue) * 100;
                    
                    const barContainer = document.createElement('div');
                    barContainer.className = 'flex items-center mb-2';
                    
                    barContainer.innerHTML = `
                        <div class="w-1/4 text-sm text-gray-600 truncate">${category}</div>
                        <div class="w-2/4 bg-gray-200 rounded h-4 mx-2">
                            <div class="chart-bar bg-blue-500 h-4 rounded" style="width: ${barHeight}%"></div>
                        </div>
                        <div class="w-1/4 text-right text-sm text-gray-600">
                            R$ ${value.toFixed(2)} (${percent.toFixed(1)}%)
                        </div>
                    `;
                    
                    chartContainer.appendChild(barContainer);
                });
            } else {
                chartContainer.innerHTML = `
                    <div class="h-full flex items-center justify-center text-gray-500">
                        <p>Nenhuma despesa para exibir no gr√°fico</p>
                    </div>
                `;
            }
        }
        
        // Deletar transa√ß√£o
        function deleteTransaction(id) {
            if (!confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) {
                return;
            }
            
            if (!dbReady) {
                alert('Banco de dados n√£o est√° pronto. Tente novamente.');
                return;
            }
            
            try {
                const transactionDB = db.transaction([STORE_NAME], 'readwrite');
                const store = transactionDB.objectStore(STORE_NAME);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    loadTransactions();
                };
                
                request.onerror = (event) => {
                    console.error('Erro ao deletar:', event.target.error);
                    alert('Erro ao excluir transa√ß√£o. Tente novamente.');
                };
            } catch (error) {
                console.error('Erro na transa√ß√£o de dele√ß√£o:', error);
                alert('Erro ao excluir transa√ß√£o. Tente novamente.');
            }
        }
        
        // Exportar para CSV
        function exportToCSV() {
            const transactionDB = db.transaction([STORE_NAME], 'readonly');
            const store = transactionDB.objectStore(STORE_NAME);
            const request = store.getAll();
            
            request.onsuccess = () => {
                const transactions = request.result;
                
                if (transactions.length === 0) {
                    alert('N√£o h√° dados para exportar.');
                    return;
                }
                
                // Cabecalho CSV
                let csv = 'Data,Tipo,Categoria,Descri√ß√£o,Valor\n';
                
                // Adicionar transa√ß√µes
                transactions.forEach(transaction => {
                    const date = new Date(transaction.date).toLocaleDateString('pt-BR');
                    const type = transaction.amount >= 0 ? 'Receita' : 'Despesa';
                    const amount = Math.abs(transaction.amount).toFixed(2);
                    
                    csv += `"${date}",${type},"${transaction.category}","${transaction.description}",${amount}\n`;
                });
                
                // Criar e fazer download do arquivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', `controle-financeiro-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
        
        // Importar de CSV
        function importFromCSV() {
            document.getElementById('csvFileInput').click();
        }
        
        // Configurar evento para input de arquivo
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                const lines = csv.split('\n');
                
                // Pular cabe√ßalho e processar linhas
                const transactions = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse simples do CSV (considerando que valores com aspas s√£o tratados)
                    const values = line.split(',').map(value => {
                        // Remover aspas se presentes
                        if (value.startsWith('"') && value.endsWith('"')) {
                            return value.substring(1, value.length - 1);
                        }
                        return value;
                    });
                    
                    if (values.length < 5) continue;
                    
                    try {
                        // Parse da data (formato dd/mm/aaaa)
                        const dateParts = values[0].split('/');
                        const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                        
                        const type = values[1].toLowerCase();
                        const category = values[2];
                        const description = values[3];
                        const amount = parseFloat(values[4]);
                        
                        if (isNaN(amount)) continue;
                        
                        transactions.push({
                            type: type === 'receita' ? 'receita' : 'despesa',
                            amount: type === 'receita' ? amount : -amount,
                            category,
                            date: formattedDate,
                            description,
                            createdAt: new Date()
                        });
                    } catch (error) {
                        console.error('Erro ao processar linha:', error);
                    }
                }
                
                if (transactions.length === 0) {
                    alert('Nenhuma transa√ß√£o v√°lida encontrada no arquivo.');
                    return;
                }
                
                // Adicionar transa√ß√µes ao banco
                const transactionDB = db.transaction([STORE_NAME], 'readwrite');
                const store = transactionDB.objectStore(STORE_NAME);
                
                let addedCount = 0;
                
                transactions.forEach(transaction => {
                    store.add(transaction).onsuccess = () => {
                        addedCount++;
                        
                        if (addedCount === transactions.length) {
                            alert(`${addedCount} transa√ß√µes importadas com sucesso!`);
                            loadTransactions();
                        }
                    };
                });
            };
            
            reader.readAsText(file);
            // Limpar input para permitir importar o mesmo arquivo novamente
            e.target.value = '';
        });
    </script>
</body>
</html>
