<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">

    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chart-bar {
            transition: height 0.5s ease-in-out;
        }

        .progress-ring {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- Cabe√ßalho -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">
                <i class="fas fa-wallet mr-2"></i>Controle Financeiro Pessoal
            </h1>
            <p class="text-gray-600">Acompanhe suas receitas e despesas de forma simples e eficiente</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Painel de Resumo -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Resumo Mensal -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Resumo Mensal</h2>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-green-600 mb-1">Receitas</p>
                            <p class="text-2xl font-bold text-green-700" id="total-receitas">R$ 0,00</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-red-600 mb-1">Despesas</p>
                            <p class="text-2xl font-bold text-red-700" id="total-despesas">R$ 0,00</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg text-center mb-6">
                        <p class="text-sm text-blue-600 mb-1">Saldo do M√™s</p>
                        <p class="text-3xl font-bold text-blue-700" id="saldo-mes">R$ 0,00</p>
                    </div>

                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">Progresso do or√ßamento</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="flex justify-between text-xs text-gray-500 mb-6">
                        <span>R$ 0,00</span>
                        <span id="meta-orcamento">R$ 0,00</span>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="exportToCSV()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm transition">
                            <i class="fas fa-download mr-1"></i> Exportar CSV
                        </button>
                        <button onclick="importFromCSV()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg text-sm transition">
                            <i class="fas fa-upload mr-1"></i> Importar CSV
                        </button>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </div>

                <!-- Distribui√ß√£o por Categoria -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Distribui√ß√£o por Categoria</h2>
                    <div id="category-chart" class="h-64"></div>
                </div>
            </div>

            <!-- Formul√°rio e Lista de Transa√ß√µes -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Formul√°rio -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Nova Transa√ß√£o</h2>
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <div class="flex rounded-md shadow-sm">
                                <button type="button" id="btn-receita" class="flex-1 py-2 px-4 rounded-l-md bg-green-500 text-white font-medium">Receita</button>
                                <button type="button" id="btn-despesa" class="flex-1 py-2 px-4 rounded-r-md bg-gray-200 text-gray-700 font-medium">Despesa</button>
                            </div>
                            <input type="hidden" id="transaction-type" value="receita">
                        </div>

                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                            <input type="number" id="amount" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <select id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                <option value="">Selecione uma categoria</option>
                            </select>
                        </div>

                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>

                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                            <input type="text" id="description" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>

                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition">
                                <i class="fas fa-plus-circle mr-1"></i> Adicionar Transa√ß√£o
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Hist√≥rico de Transa√ß√µes -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico de Transa√ß√µes</h2>
                        <div class="flex space-x-2">
                            <select id="filter-month" class="px-3 py-1 border border-gray-300 rounded-md text-sm"></select>
                            <select id="filter-year" class="px-3 py-1 border border-gray-300 rounded-md text-sm"></select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-500 border-b">
                                    <th class="pb-2">Data</th>
                                    <th class="pb-2">Descri√ß√£o</th>
                                    <th class="pb-2">Categoria</th>
                                    <th class="pb-2 text-right">Valor</th>
                                    <th class="pb-2 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list"></tbody>
                        </table>
                    </div>

                    <div id="empty-state" class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-4xl mb-2"></i>
                        <p>Nenhuma transa√ß√£o encontrada</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Script -->
<script>
    // --- Vari√°veis globais e refer√™ncias ao DOM ---
    let db; // Vari√°vel para armazenar a inst√¢ncia do IndexedDB
    const DB_NAME = "FinanceDB2"; // Nome do banco
    const DB_VERSION = 2; // Vers√£o do banco
    const STORE_NAME = "transactions"; // Nome do object store

    // Categorias de transa√ß√µes
    const categories = {
        receita: ["Sal√°rio", "Freelance", "Investimentos", "Presente", "Outros"],
        despesa: ["Alimenta√ß√£o", "Transporte", "Moradia", "Sa√∫de", "Educa√ß√£o", "Lazer", "Compras", "Outros"]
    };

    // Refer√™ncias aos elementos do HTML
    const transactionForm = document.getElementById('transaction-form');
    const transactionsList = document.getElementById('transactions-list');
    const emptyState = document.getElementById('empty-state');
    const totalReceitas = document.getElementById('total-receitas');
    const totalDespesas = document.getElementById('total-despesas');
    const saldoMes = document.getElementById('saldo-mes');
    const progressBar = document.getElementById('progress-bar');
    const btnReceita = document.getElementById('btn-receita');
    const btnDespesa = document.getElementById('btn-despesa');
    const transactionType = document.getElementById('transaction-type');
    const categorySelect = document.getElementById('category');
    const filterMonth = document.getElementById('filter-month');
    const filterYear = document.getElementById('filter-year');
    const amountInput = document.getElementById('amount');
    const dateInput = document.getElementById('date');

    // --- Inicializa√ß√£o do app ---
    document.addEventListener('DOMContentLoaded', () => {
        // Preencher campo de data com a data atual
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];

        // Popular filtros de m√™s e ano
        populateMonthYearFilters();

        // Popular categorias iniciais
        updateCategoryOptions();

        // Inicializar IndexedDB
        initDB().then(loadTransactions).catch(console.error);

        // Configurar eventos de clique e submit
        setupEventListeners();
    });

    // --- Configura√ß√£o de eventos ---
    function setupEventListeners() {
        btnReceita.addEventListener('click', () => setTransactionType('receita'));
        btnDespesa.addEventListener('click', () => setTransactionType('despesa'));
        transactionForm.addEventListener('submit', addTransaction);
        filterMonth.addEventListener('change', loadTransactions);
        filterYear.addEventListener('change', loadTransactions);
        amountInput.addEventListener('blur', formatCurrency);
        document.getElementById('csvFileInput').addEventListener('change', handleCSVImport);
    }

    // --- Formata√ß√£o de valores monet√°rios ---
    function formatCurrency(e) {
        let value = parseFloat(e.target.value);
        if (!isNaN(value)) e.target.value = value.toFixed(2);
    }

    // --- Popular filtros de m√™s e ano ---
    function populateMonthYearFilters() {
        const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        const currentMonth = new Date().getMonth();
        months.forEach((m,i)=>{
            const opt=document.createElement('option');
            opt.value=i+1;
            opt.textContent=m;
            if(i===currentMonth) opt.selected=true;
            filterMonth.appendChild(opt);
        });

        const currentYear = new Date().getFullYear();
        for(let i=currentYear-5;i<=currentYear+1;i++){
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=i;
            if(i===currentYear) opt.selected=true;
            filterYear.appendChild(opt);
        }
    }

    // --- Alternar tipo de transa√ß√£o (Receita / Despesa) ---
    function setTransactionType(type) {
        transactionType.value = type;
        if(type==='receita'){
            btnReceita.classList.replace('bg-gray-200','bg-green-500'); 
            btnReceita.classList.replace('text-gray-700','text-white');
            btnDespesa.classList.replace('bg-red-500','bg-gray-200'); 
            btnDespesa.classList.replace('text-white','text-gray-700');
        } else {
            btnDespesa.classList.replace('bg-gray-200','bg-red-500'); 
            btnDespesa.classList.replace('text-gray-700','text-white');
            btnReceita.classList.replace('bg-green-500','bg-gray-200'); 
            btnReceita.classList.replace('text-white','text-gray-700');
        }
        updateCategoryOptions();
    }

    // --- Atualizar op√ß√µes de categorias ---
    function updateCategoryOptions() {
        categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
        categories[transactionType.value].forEach(cat=>{
            const opt=document.createElement('option'); 
            opt.value=cat; 
            opt.textContent=cat; 
            categorySelect.appendChild(opt);
        });
    }

    // --- Inicializar IndexedDB ---
    function initDB(){
        return new Promise((resolve,reject)=>{
            const req=indexedDB.open(DB_NAME,DB_VERSION);

            // Erro ao abrir DB
            req.onerror=()=>reject(req.error);

            // Sucesso ao abrir DB
            req.onsuccess=()=>{db=req.result; resolve(db);}

            // Criar object store se n√£o existir
            req.onupgradeneeded=(e)=>{
                const db=e.target.result;
                if(!db.objectStoreNames.contains(STORE_NAME)){
                    const store=db.createObjectStore(STORE_NAME,{keyPath:'id',autoIncrement:true});
                    store.createIndex('date','date',{unique:false});
                    store.createIndex('type','type',{unique:false});
                    store.createIndex('category','category',{unique:false});
                }
            }
        });
    }

    // --- Adicionar nova transa√ß√£o ---
    function addTransaction(e){
        e.preventDefault();

        const type = transactionType.value;
        const amount = parseFloat(amountInput.value);
        const category = categorySelect.value;
        const date = dateInput.value;
        const description = document.getElementById('description').value;

        // Valida√ß√£o
        if(!amount || !category || !date || !description){
            alert('Preencha todos os campos'); 
            return;
        }

        // Criar objeto da transa√ß√£o
        const transaction = {
            type,
            amount: type==='despesa'?-amount:amount,
            category,
            date,
            description,
            createdAt: new Date()
        };

        // Salvar no IndexedDB
        const tx = db.transaction([STORE_NAME],'readwrite'); 
        const store = tx.objectStore(STORE_NAME); 
        store.add(transaction).onsuccess = () => {
            transactionForm.reset(); 
            dateInput.value = new Date().toISOString().split('T')[0]; 
            setTransactionType('receita'); 
            loadTransactions();
        };
    }

    // --- Carregar transa√ß√µes do DB e filtrar ---
    function loadTransactions(){
        const month=parseInt(filterMonth.value);
        const year=parseInt(filterYear.value);
        const tx = db.transaction([STORE_NAME],'readonly'); 
        const store = tx.objectStore(STORE_NAME);

        store.getAll().onsuccess=(e)=>{
            const all=e.target.result;
            const filtered = all.filter(t=>{
                const d = new Date(t.date); 
                return d.getMonth()+1===month && d.getFullYear()===year;
            });
            filtered.sort((a,b)=>new Date(b.date)-new Date(a.date));
            displayTransactions(filtered);
            updateSummary(filtered);
            updateChart(filtered);
        }
    }

    // --- Exibir transa√ß√µes na tabela ---
    function displayTransactions(transactions){
        transactionsList.innerHTML='';
        if(transactions.length===0){emptyState.classList.remove('hidden'); return;}
        emptyState.classList.add('hidden');

        transactions.forEach(t=>{
            const row=document.createElement('tr'); 
            row.className='border-b hover:bg-gray-50 fade-in';
            const date=new Date(t.date).toLocaleDateString('pt-BR');
            const amountClass=t.amount>=0?'text-green-600':'text-red-600';
            const icon=t.amount>=0?'fa-arrow-up-right':'fa-arrow-down-left';
            row.innerHTML=`
                <td class="py-3">${date}</td>
                <td class="py-3">${t.description}</td>
                <td class="py-3">
                    <span class="px-2 py-1 text-xs rounded-full ${t.amount>=0?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${t.category}</span>
                </td>
                <td class="py-3 text-right font-medium ${amountClass}">
                    <i class="fas ${icon} mr-1"></i> R$ ${Math.abs(t.amount).toFixed(2)}
                </td>
                <td class="py-3 text-center">
                    <button onclick="deleteTransaction(${t.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>`;
            transactionsList.appendChild(row);
        });
    }

    // --- Atualizar resumo financeiro ---
    function updateSummary(transactions){
        let totalIncome=0,totalExpense=0;
        transactions.forEach(t=>{ t.amount>=0?totalIncome+=t.amount:totalExpense+=Math.abs(t.amount); });
        const balance=totalIncome-totalExpense;
        totalReceitas.textContent=`R$ ${totalIncome.toFixed(2)}`;
        totalDespesas.textContent=`R$ ${totalExpense.toFixed(2)}`;
        saldoMes.textContent=`R$ ${balance.toFixed(2)}`;

        // Progresso do or√ßamento
        const expenseGoal=0.7*totalIncome;
        document.getElementById('meta-orcamento').textContent=`R$ ${expenseGoal.toFixed(2)}`;
        if(expenseGoal>0){
            const percent=Math.min(100,(totalExpense/expenseGoal)*100);
            progressBar.style.width=`${percent}%`;
            progressBar.className=percent>90?'bg-red-600 h-2.5 rounded-full':percent>70?'bg-yellow-500 h-2.5 rounded-full':'bg-green-600 h-2.5 rounded-full';
        } else progressBar.style.width='0%';
    }

    // --- Gerar gr√°fico por categoria de despesa ---
    function updateChart(transactions){
        const container=document.getElementById('category-chart'); 
        container.innerHTML='';
        const expenses={};
        transactions.forEach(t=>{if(t.amount<0){expenses[t.category]=(expenses[t.category]||0)+Math.abs(t.amount);}});
        const sorted=Object.entries(expenses).sort((a,b)=>b[1]-a[1]);
        const total=sorted.reduce((s,[,v])=>s+v,0);
        if(sorted.length>0){
            const maxVal=Math.max(...sorted.map(([,v])=>v));
            sorted.forEach(([cat,val])=>{
                const barHeight=(val/maxVal)*100;
                const percent=(val/total)*100;
                const div=document.createElement('div'); div.className='flex items-center mb-2';
                div.innerHTML=`
                    <div class="w-1/4 text-sm text-gray-600 truncate">${cat}</div>
                    <div class="w-2/4 bg-gray-200 rounded h-4 mx-2">
                        <div class="chart-bar bg-blue-500 h-4 rounded" style="width:${barHeight}%"></div>
                    </div>
                    <div class="w-1/4 text-right text-sm text-gray-600">R$ ${val.toFixed(2)} (${percent.toFixed(1)}%)</div>`;
                container.appendChild(div);
            });
        } else container.innerHTML='<div class="h-full flex items-center justify-center text-gray-500"><p>Nenhuma despesa para exibir no gr√°fico</p></div>';
    }

    // --- Excluir transa√ß√£o ---
    function deleteTransaction(id){
        if(!confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) return;
        const tx=db.transaction([STORE_NAME],'readwrite'); 
        const store=tx.objectStore(STORE_NAME);
        store.delete(id).onsuccess=loadTransactions;
    }

    // --- Exportar CSV ---
    function exportToCSV(){
        const tx=db.transaction([STORE_NAME],'readonly'); 
        const store=tx.objectStore(STORE_NAME);
        store.getAll().onsuccess=e=>{
            const transactions=e.target.result;
            if(transactions.length===0){alert('N√£o h√° dados para exportar.'); return;}
            let csv='Data,Tipo,Categoria,Descri√ß√£o,Valor\n';
            transactions.forEach(t=>{
                const date=new Date(t.date).toLocaleDateString('pt-BR'); 
                const type=t.amount>=0?'Receita':'Despesa'; 
                const amount=Math.abs(t.amount).toFixed(2); 
                csv+=`"${date}",${type},"${t.category}","${t.description}",${amount}\n`;
            });
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); 
            const url=URL.createObjectURL(blob);
            const link=document.createElement('a'); 
            link.setAttribute('href',url); 
            link.setAttribute('download',`controle-financeiro-${new Date().toISOString().split('T')[0]}.csv`); 
            link.style.visibility='hidden'; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
        };
    }

    // --- Importar CSV ---
    function importFromCSV(){document.getElementById('csvFileInput').click();}

    // --- Processar CSV importado ---
    function handleCSVImport(e){
        const file=e.target.files[0]; 
        if(!file) return;
        const reader=new FileReader();
        reader.onload=ev=>{
            const csv=ev.target.result;
            const lines=csv.split('\n');
            const transactions=[];
            for(let i=1;i<lines.length;i++){
                const line=lines[i].trim(); 
                if(!line) continue;
                const values=line.split(',').map(v=>v.startsWith('"')&&v.endsWith('"')?v.slice(1,-1):v);
                if(values.length<5) continue;
                try{
                    const [dd,mm,yyyy]=values[0].split('/');
                    const formattedDate=`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
                    const type=values[1].toLowerCase();
                    const category=values[2];
                    const description=values[3];
                    const amount=parseFloat(values[4]);
                    if(isNaN(amount)) continue;
                    transactions.push({
                        type:type==='receita'?'receita':'despesa',
                        amount:type==='receita'?amount:-amount,
                        category,
                        date:formattedDate,
                        description,
                        createdAt:new Date()
                    });
                }catch(err){console.error(err);}
            }
            if(transactions.length===0){alert('Nenhuma transa√ß√£o v√°lida encontrada.'); return;}
            const tx=db.transaction([STORE_NAME],'readwrite'); 
            const store=tx.objectStore(STORE_NAME);
            let addedCount=0;
            transactions.forEach(t=>store.add(t).onsuccess=()=>{
                addedCount++; 
                if(addedCount===transactions.length){
                    alert(`${addedCount} transa√ß√µes importadas com sucesso!`); 
                    loadTransactions();
                }
            });
        };
        reader.readAsText(file); 
        e.target.value='';
    }
</script>

</body>
</html>
